<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <title>Kitchen App</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
        background-color: #f9f9f9;
        color: #111;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      }
      #container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      #photo {
        width: 300px;
        height: 300px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #333;
        margin-bottom: 20px;
      }
      .btn {
        min-width: 250px;
        padding: 10px 20px;
        margin: 10px;
        font-size: 18px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 32px;
      }
      .btn:active {
        transform: scale(0.96);
        background-color: #dcdcdc;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .btn-clear {
        background-color: #e74c3c;
        color: white;
      }
      .btn-print {
        background-color: #2ecc71;
        color: white;
      }
      #name {
        margin: 0;
        font-size: 48px;
      }
      #status {
        font-size: 32px;
      }
      #message {
        font-size: 64px;
      }
      .fade-in {
        opacity: 0;
        animation: fadeIn 0.5s forwards;
      }

      .fade-out {
        opacity: 1;
        animation: fadeOut 0.5s forwards;
      }
      #toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #e74c3c;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        opacity: 0;
        pointer-events: none;
        transform: translateX(100%);
        transition: opacity 0.5s ease, transform 0.5s ease;
        z-index: 9999;
      }

      /* Paydo bo'lish animatsiyasi */
      #toast.show {
        opacity: 1;
        pointer-events: auto;
        transform: translateX(0);
      }

      /* Yo'qolish animatsiyasi */
      #toast.hide {
        opacity: 0;
        pointer-events: none;
        transform: translateX(100%);
      }

      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        to {
          opacity: 0;
        }
      }
      #lottie {
        width: 400px;
        height: 400px;
        margin: 0 auto;
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- Toast konteyner -->
    <div id="toast"></div>

    <div id="container">
      <div id="lottie"></div>
      <h1 id="message">Kameraga yuzingizni tuting</h1>
      <img id="photo" style="display: none" />
      <h2 id="name"></h2>
      <p id="status"></p>
      <div id="buttons"></div>
    </div>

    <script src="./lotite.js"></script>
    <script>
      const baseUrl = "http://172.25.24.220:8444";
      const printerUrl = "http://localhost:7001";
      const animationDuration = 200;

      const messageEl = document.getElementById("message");
      const photoEl = document.getElementById("photo");
      const nameEl = document.getElementById("name");
      const statusEl = document.getElementById("status");
      const buttonsEl = document.getElementById("buttons");

      let timeoutId = null;
      let ws = null;
      let reconnectInterval = null;
      let animation = null;
      let isAnimate = false;

      function fadeOutAndHide(el) {
        el.classList.remove("fade-in");
        el.classList.add("fade-out");
        setTimeout(() => {
          el.style.display = "none";
          el.classList.remove("fade-out");
        }, animationDuration); // animation duration bilan mos
      }

      function clearScreen() {
        fadeOutAndHide(photoEl);
        fadeOutAndHide(nameEl);
        fadeOutAndHide(statusEl);
        fadeOutAndHide(buttonsEl);
        if (isAnimate == true) {
          setTimeout(() => {
            messageEl.innerText = "Kameraga yuzingizni tuting";
          }, animationDuration + 1600);
        } else {
          setTimeout(() => {
            messageEl.innerText = "Kameraga yuzingizni tuting";
          }, animationDuration);
        }

        if (timeoutId) clearTimeout(timeoutId);
      }

      function showWithFade(el, display = "block") {
        el.style.display = display;
        el.classList.remove("fade-out");
        el.classList.add("fade-in");
      }

      function showToast(message, duration = 3000) {
        const toast = document.getElementById("toast");
        toast.innerText = message;

        // Show toast with animation
        toast.classList.remove("hide");
        toast.classList.add("show");

        // Timeout for hiding toast
        setTimeout(() => {
          // Hide toast with animation
          toast.classList.remove("show");
          toast.classList.add("hide");
        }, duration);
      }

      function handleMessage(data) {
        const employee = data.message.data;
        const time = data.message.time;
        const photoUrl = baseUrl + employee.photo_url;

        messageEl.innerText = "";

        photoEl.src = photoUrl;
        showWithFade(photoEl);

        nameEl.innerText = employee.name;
        showWithFade(nameEl);

        buttonsEl.innerHTML = "";
        showWithFade(buttonsEl);

        const clearBtn = document.createElement("button");
        clearBtn.innerText = "Tozalash";
        clearBtn.className = "btn btn-clear";
        clearBtn.onclick = clearScreen;
        buttonsEl.appendChild(clearBtn);

        if (employee.checked_today) {
          statusEl.innerText = "Siz bugun talon olgansiz";
        } else {
          statusEl.innerText =
            "Siz bugun talon olmagansiz, talon olishingiz mumkin";
          const printBtn = document.createElement("button");
          printBtn.innerText = "Talon chop etish";
          printBtn.className = "btn btn-print";
          printBtn.onclick = () => {
            isAnimate = true;
            clearScreen();
            setTimeout(() => {
              const container = document.getElementById("lottie");
              container.style.display = "block";

              if (!animation) {
                // Agar hali yuklanmagan bo‘lsa, yuklaymiz
                animation = lottie.loadAnimation({
                  container,
                  renderer: "svg",
                  loop: false,
                  autoplay: true, // Qo‘lda boshqaramiz
                  path: "./okey.json",
                });

                animation.setSpeed(3.0);

                animation.addEventListener("complete", () => {
                  container.style.display = "none";
                });
              } else {
                animation.goToAndPlay(0); // Boshlanishdan qayta o‘ynatish
              }
              isAnimate = false;
            }, 200);
            fetch(`${printerUrl}/print`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                employee_id: employee?.employee_id,
                turniket_id: employee?.turniket_id,
                name: employee?.name,
                date: time,
              }),
            })
              .then((res) => {
                if (res.ok) {
                  return fetch(`${baseUrl}/checkyesno/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      employee_id: employee.employee_id,
                      turniket_id: employee.turniket_id,
                      yes: true,
                    }),
                  });
                } else {
                  showToast("Tarmoq yoki server bilan aloqa uzildi");
                }
              })
              .then((res) => {
                if (res.status === 200) {
                  clearScreen();
                } else {
                  showToast("Ma'lumotni saqlashda xatolik");
                }
              })
              .catch((err) => {
                showToast("Printerga yuborishda xatolik");
              });
          };
          buttonsEl.appendChild(printBtn);
        }
        showWithFade(statusEl);
        if (timeoutId) clearTimeout(timeoutId);
        timeoutId = setTimeout(clearScreen, 10000);
      }

      function connectWebSocket() {
        ws = new WebSocket(baseUrl.replace(/^http/, "ws") + "/ws/chat/");

        ws.onopen = () => {
          console.log("WebSocket ulandi");
          if (reconnectInterval) {
            clearInterval(reconnectInterval);
            reconnectInterval = null;
          }
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.message && data.message.return === "success") {
              handleMessage(data);
            }
          } catch (err) {
            console.error("Xatolik:", err);
          }
        };

        ws.onclose = () => {
          console.log("WebSocket uzildi, qayta ulanmoqda...");
          if (!reconnectInterval) {
            reconnectInterval = setInterval(connectWebSocket, 3000);
          }
        };

        ws.onerror = (err) => {
          console.error("WebSocket xato:", err);
          ws.close();
        };
      }

      clearScreen();
      connectWebSocket();
    </script>
  </body>
</html>
